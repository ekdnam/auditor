---
title: "R Notebook"
output: html_notebook
---
```{r include=FALSE}
library(jsonlite)
library(writexl)
library(readxl)
library(dplyr)
library(car)
```

First we need to import the data and tidy up the datatypes a bit

```{r, results="hide"}
datafile <- file("bkp/output-www1/test.json", open="r")
data <- stream_in(datafile, flatten=TRUE)
close(datafile)
data$treatment.ethnicity <- as.factor(data$treatment.ethnicity)
data$treatment.gender <- as.factor(data$treatment.gender)
data$type <- as.factor(data$type)
data$scraper <- as.factor(data$scraper)
data$block_id <- as.factor(data$block_id)
data$agent_id <- as.factor(data$agent_id)
```

Now we split off just the ads from our data
```{r}
ads <- data[data$type == 'ad', ]
ads$ranking <- NULL
# rankings <- data[data$type == 'ranking', ]
# rankings$ad <- NULL
```

Next we write out the data for coding
```{r}
unique_ads <- unique(ads[c("ad.title", "ad.url")])
write_xlsx(unique_ads, "bkp/output-www1/unique-ads.xlsx")
```

Now code the results, read them back in, and join them to the existing data
```{r}
categorized_ads <- read_excel("bkp/output-www1/unique-ads-coded.xlsx")
categorized_ads$ad.category <- as.factor(categorized_ads$ad.category)
categorized_ads$ad.title <- NULL
merged <- merge(x=ads, y=categorized_ads)
```

Count how many ads we have in each category
```{r}
number_ads <- count(merged, agent_id, treatment.gender, treatment.ethnicity, scraper)
aggregator_ads <- count(subset(merged, ad.category == "aggregator"), agent_id, treatment.gender, treatment.ethnicity, scraper)
realtor_ads <- count(subset(merged, ad.category == "realtor"), agent_id, treatment.gender, treatment.ethnicity, scraper)
```

Perform a two-way anova test
```{r}
aggregator_ads <- count(subset(merged, ad.category == "aggregator"), agent_id, treatment.gender, treatment.ethnicity, scraper)
res.aggregator <- aov(n ~ treatment.ethnicity * treatment.gender, data = aggregator_ads)
summary(res.aggregator)
```

```{r}
realtor_ads <- count(subset(merged, ad.category == "realtor"), agent_id, treatment.gender, treatment.ethnicity, scraper)
res.realtor <- aov(n ~ treatment.ethnicity * treatment.gender, data = realtor_ads)
summary(res.realtor)

anova(res.realtor)
```

None of our values are below the threshold of 0.05, so none of these are statistically significant.

Finally, we should check the assumptions of our ANOVA test. First, we check the plot of residuals vs fit, and Levene's test for homogeneity of variance
```{r}
plot(res.aggregator, 1)
plot(res.realtor, 1)
leveneTest(n ~ treatment.ethnicity * treatment.gender, data = aggregator_ads)
leveneTest(n ~ treatment.ethnicity * treatment.gender, data = realtor_ads)
```
The data has several possible outliers, which may negatively impact the normality and homogeneity assumptions of ANOVA. However, our p-value is above the significance level, so there is no evidence that the variance across groups is significantly different. Therefore, we can assume the variances are homogenous across the different treatments.

We also check normality both by plotting it against the quantiles of a normal distribution, and using the Shapiro-Wilk test.
```{r}
plot(res.aggregator, 2)
res.aggregator_residuals <- residuals(object = res.aggregator)
res.realtor_residuals <- residuals(object = res.realtor)
shapiro.test(x = res.aggregator_residuals )
shapiro.test(x = res.realtor_residuals )
```